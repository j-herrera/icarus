<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>ISS plots</title>
    <style>
        .x.axis line {
            shape-rendering: auto;
        }
        .y.axis line {
            shape-rendering: auto;
        }

        .line {
            fill: none;
            stroke: #000;
            stroke-width: 1.5px;
        }
    </style>
    <script src='http://d3js.org/d3.v3.min.js'></script>
  </head>
  <body>
	<div>
		<select id="variable-list">
			<option value=2>Inclination</option>
			<option value=3>Right Ascension of the Ascending Node</option>
			<option value=4>Eccentricity</option>
			<option value=5>Argument of Perigee</option>
			<option value=6>Mean Anomaly</option>
			<option value=7>Mean Motion</option>
			<option value=8>Latitude</option>
			<option value=9>Longitude</option>
			<option value=10>Altitude</option>
			<option value=11>Velocity</option>
		</select>
	</div>
    <script>
		var plotDataIndex = 2;

		var alertChange = function() {
			var selectedValue = d3.event.target.value;
			var selectedIndex = d3.event.target.selectedIndex;
			console.log(selectedIndex);

			plotDataIndex = 2 + selectedIndex;
			console.log(plotDataIndex)
		}

		d3.select('#variable-list').on('change', alertChange);
		var n = 10;
		var data = [
			{name:'epochYear', values:d3.range(0)},
			{name:'epoch', values:d3.range(0)},
			{name:'inclination', values:d3.range(0)},
			{name:'RAAN', values:d3.range(0)},
			{name:'eccentricity', values:d3.range(0)},
			{name:'arg_perigee', values:d3.range(0)},
			{name:'mean_anomaly', values:d3.range(0)},
			{name:'mean_motion', values:d3.range(0)},
			{name:'latitude', values:d3.range(0)},
			{name:'longitude', values:d3.range(0)},
			{name:'altitude', values:d3.range(0)},
			{name:'velocity', values:d3.range(0)}
		]
		var margin = {top: 10, right: 20, bottom: 30, left: 50},
    		width = 960 - margin.left - margin.right,
		    height = 600 - margin.top - margin.bottom;

		var x = d3.scale.linear()
			.domain([0, n - 1])
			.range([0, width]);
		var y = d3.scale.linear()
			.domain([-90, 90])
			.range([height, 0]);

		var yAxis = d3.svg.axis().scale(y).orient('right').ticks(5);

		var valueLine = d3.svg.line()
			.x(function(d, i) {return x(i);})
			.y(function(d, i) {return y(d);});

		var svg = d3.select('body')
			.append('svg')
				.attr('width', width + margin.left + margin.right)
				.attr('height', height + margin.top + margin.bottom)
				.style('margin-left', -margin.left + 'px')
			.append('g')
				.attr('transform',
					'translate(' + margin.left + ',' + margin.top + ')');

		function initialiseData(data) {
			var jsonData;
			d3.json('api/getISSData', function(error, json) {
				if (error) return console.warn(error);
				jsonData = json;
				
				data[0].values.push(jsonData.epochYear);
				data[1].values.push(jsonData.epoch);
				data[2].values.push(jsonData.inc);
				data[3].values.push(jsonData.raan);
				data[4].values.push(jsonData.ecc);
				data[5].values.push(jsonData.aper);
				data[6].values.push(jsonData.ma);
				data[7].values.push(jsonData.mm);
				data[8].values.push(jsonData.lat);
				data[9].values.push(jsonData.lon);
				data[10].values.push(jsonData.alt);
				data[11].values.push(jsonData.vel);

				svg.append('path')
					.attr('class', 'line')
					.attr('d', valueLine(data[plotDataIndex].values));

				svg.append('g')
					.attr('class', 'y axis')
					.call(yAxis);
			});
		}

		initialiseData(data);


		function updateData(data) {
	        var jsonData;
    	    d3.json('api/getISSData', function(error, json) {
    	        if (error) return console.warn(error);
    	        jsonData = json;

				data[0].values.push(jsonData.epochYear);
				data[1].values.push(jsonData.epoch);
				data[2].values.push(jsonData.inc);
				data[3].values.push(jsonData.raan);
				data[4].values.push(jsonData.ecc);
				data[5].values.push(jsonData.aper);
				data[6].values.push(jsonData.ma);
				data[7].values.push(jsonData.mm);
				data[8].values.push(jsonData.lat);
				data[9].values.push(jsonData.lon);
				data[10].values.push(jsonData.alt);
				data[11].values.push(jsonData.vel);

				y.domain([d3.min(data[plotDataIndex].values), d3.max(data[plotDataIndex].values)]);
				var svg = d3.select('body');

				if (data[9].values.length > n - 1) {
					var path = svg.select('path');
					path.attr('d', valueLine(data[plotDataIndex].values))
						.attr('transform', null)
						.transition()
							.duration(0)
							.attr('transform', 'translate(' + x(-1) + ')');
					for (ii = 0; ii < 12; ii++) {
						data[ii].values.shift();
					}
				} else {
					svg.select('.line')
						.attr('d', valueLine(data[plotDataIndex].values))
						.attr('transform', null);
				}
						
				svg.select('.y.axis')
					.transition()
					.duration(0)
					.call(yAxis);
				console.log(data[plotDataIndex].values);
			});
		}

		setInterval(function() {
			updateData(data);
		}, 2000);
					
		
		
    </script>
    </body>
</html>
